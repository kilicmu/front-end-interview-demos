### 传输层

### UDP

UDP又称用户数据报协议。

面向**无连接**的，**最大可能交付**协议。**没有拥塞控制**，面向报文传输，支持一对一，一对多，多对多，多对一传输

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

![UDP报文格式](https://i.niupic.com/images/2020/10/12/8RKd.png)

### TCP

##### 三次握手：

- **客户端** 向 **服务端** 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。
- **服务端** 收到连接请求报文，如果同意建立连接，则向 **客户端** 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。
- **客户端** 收到 **服务端** 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。
- **服务端** 收到 **客户端** 的确认后，连接建立。

##### 四次挥手：

- **客户端** 发送连接释放报文，FIN=1。
- **服务端** 收到之后发出确认，此时 TCP 属于半关闭状态，**服务端** 能向 **客户端** 发送数据但是 **客户端** 不能向 **服务端** 发送数据。
- 当 **服务端** 不再需要连接时，发送连接释放报文，FIN=1。
- **客户端** 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
- **服务端** 收到 **客户端** 的确认后释放连接。

##### TIME_WAIT

客户端接收到服务器端的 FIN 报文后的状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：

* 确保最后一个确认报文能够到达。如果 **服务端** 没收到 **客户端** 发送来的确认报文，那么就会重新发送连接释放请求报文，**客户端** 等待一段时间就是为了处理这种情况的发生。
* 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

##### TCP 可靠传输

原理： 超时重连机制

超时时间计算：

​				RTTs = (1 - a) * (RTTs) + a * RTT

​				RTO = RTTs + 4 * RTTd

RTTd为偏差的加权平均值。

##### TCP 滑动窗口

窗口是缓存的一部分，用来暂时存放字节流。

发送方和接收方各有一个窗口。接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。

如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。

接收窗口只会对窗口内最后一个按序到达的字节进行确认，例如接收窗口已经收到的字节为 {31, 34, 35}，其中 {31} 按序到达，而 {34, 35} 就不是，因此只对字节 31 进行确认。发送方得到一个字节的确认之后，就知道这个字节之前的所有字节都已经被接收。

##### 流量控制

控制发送方速率，保证接收方来得及接收。

接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小。

发送方窗口为0无法发送数据

##### 拥塞控制

慢开始、拥塞避免、快重传、快恢复。

1. 慢开始，拥塞避免：
   * 发送方需要维护一个叫做拥塞窗口（cwnd）的状态变量
   * 发送的最初执行慢开始，令 cwnd = 1，发送方只能发送 1 个报文段，当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 ...
   * 设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。
   * 如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。
2. 快重传，快恢复： 
   * 在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。
   * 在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。
   * 在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。
   * 快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。

